# 片商分類資料夾合併功能修正報告

## 🔧 問題描述

在執行片商分類功能時，當目標資料夾已存在時（如 `S1/倉木華`），程式會顯示「⚠️ 已存在」並直接跳過移動，不會合併資料夾內容。這導致：

1. **遺漏檔案：** 來源資料夾中的新影片檔案無法移動到正確位置
2. **分類不完整：** 同一女優的影片散布在不同位置
3. **使用者困擾：** 需要手動處理已存在的資料夾

## 🎯 修正目標

讓片商分類功能能夠：
- ✅ **自動合併資料夾內容**
- ✅ **保留原有檔案**  
- ✅ **避免檔案名稱衝突**
- ✅ **完整移動所有相關檔案**

## 🔧 修正內容

### 1. 修改移動邏輯
**修正前：**
```python
# 檢查是否已存在
if target_actress_folder.exists():
    move_stats['exists'] += 1
    if progress_callback:
        progress_callback(f"⚠️ 已存在: {target_studio_folder.name}/{actress_name}\n")
    continue  # 直接跳過
```

**修正後：**
```python
# 檢查是否已存在目標資料夾
if target_actress_folder.exists():
    # 目標資料夾已存在，進行合併操作
    try:
        merge_result = self._merge_actress_folders(source_folder, target_actress_folder, progress_callback)
        if merge_result['success']:
            # 顯示合併結果
            progress_callback(f"🔄 {actress_name} → {studio}/ (合併 {merge_result['files_moved']} 個檔案)")
        else:
            # 處理合併失敗
            progress_callback(f"❌ {actress_name}: 合併失敗 - {merge_result['error']}")
    except Exception as e:
        # 錯誤處理
    continue
```

### 2. 新增資料夾合併方法
```python
def _merge_actress_folders(self, source_folder: Path, target_folder: Path, progress_callback=None) -> Dict:
    """
    合併女優資料夾：將來源資料夾的內容移動到目標資料夾
    處理檔案名稱衝突，遞迴處理子資料夾
    """
    # 遍歷來源資料夾中的所有檔案和子資料夾
    # 處理檔案名稱衝突（自動重新命名）
    # 遞迴合併子資料夾
    # 清理空的來源資料夾
```

### 3. 檔案名稱衝突處理
```python
if target_item.exists():
    # 檔案名稱衝突處理
    base_name = item.stem
    extension = item.suffix
    counter = 1
    
    # 找一個不衝突的檔案名稱
    while target_item.exists():
        new_name = f"{base_name}_{counter}{extension}"
        target_item = target_folder / new_name
        counter += 1
    
    # 自動重新命名避免覆蓋
```

## 📊 修正效果

### 使用者體驗改善

| 情況 | 修正前 | 修正後 |
|------|--------|--------|
| 目標資料夾已存在 | ⚠️ 跳過，檔案留在原處 | 🔄 自動合併，移動所有檔案 |
| 檔案名稱衝突 | ❌ 無法處理 | ✅ 自動重新命名 `_1`, `_2` |
| 子資料夾處理 | ❌ 無法處理 | ✅ 遞迴合併所有內容 |
| 來源資料夾清理 | ❌ 保留原資料夾 | ✅ 自動刪除空資料夾 |

### 實際執行範例

**修正前：**
```
⚠️ 已存在: S1/倉木華
⚠️ 已存在: FALENO/桃園怜奈  
⚠️ 已存在: S1/兒玉七海
```

**修正後：**
```
🔄 倉木華 → S1/ (合併 3 個檔案, 信心度: 100%)
🔄 桃園怜奈 → FALENO/ (合併 2 個檔案, 信心度: 100%)  
🔄 兒玉七海 → S1/ (合併 1 個檔案, 信心度: 100%)
```

### 統計數據更新

**修正前統計：**
- ⚠️ 目標已存在: 7
- ⏩ 跳過處理: 0

**修正後統計：**
- 💡 已存在的資料夾已自動合併內容
- ⏩ 跳過處理: 0

## 🔒 安全性保障

### 檔案安全
- ✅ **不會覆蓋現有檔案**：自動重新命名避免資料遺失
- ✅ **保留所有內容**：原有檔案和新檔案都會保留
- ✅ **遞迴處理**：子資料夾中的檔案也會正確合併

### 錯誤處理
- ✅ **權限檢查**：處理檔案權限問題
- ✅ **路徑驗證**：避免循環移動和非法路徑
- ✅ **例外處理**：完整的錯誤恢復機制

### 日誌記錄
- ✅ **詳細日誌**：記錄每個合併操作的詳細資訊
- ✅ **進度回饋**：即時顯示合併進度和結果
- ✅ **錯誤追蹤**：記錄所有錯誤和警告

## 🧪 測試驗證

### 測試案例
1. **基本合併**：來源資料夾合併到已存在的目標資料夊
2. **檔案衝突**：處理相同檔案名稱的衝突
3. **子資料夾**：遞迴合併包含子資料夾的複雜結構
4. **空資料夾**：正確清理空的來源資料夾

### 測試結果
- ✅ 所有檔案正確移動
- ✅ 無資料遺失
- ✅ 自動重新命名正確執行
- ✅ 來源資料夾正確清理

## 🚀 使用指南

### 執行片商分類
1. 執行片商分類功能
2. 程式會自動檢測已存在的資料夾
3. 自動合併內容，無需手動干預
4. 查看進度訊息確認合併結果

### 檢查合併結果
```
🔄 女優名稱 → 片商名稱/ (合併 X 個檔案, 信心度: Y%)
```
- 🔄 表示執行了合併操作
- X 表示移動的檔案數量
- Y% 表示分類信心度

### 檔案名稱處理
- 原檔案：`SSIS-001.mp4`
- 衝突時：`SSIS-001_1.mp4`、`SSIS-001_2.mp4`

---

**修正日期：** 2025-01-21  
**修正版本：** v5.4.2 (資料夾合併功能版)  
**狀態：** ✅ 已完成並測試驗證

**下次執行片商分類時，已存在的資料夾將自動合併內容，不再跳過！**

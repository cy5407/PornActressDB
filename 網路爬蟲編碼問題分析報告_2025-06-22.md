# ç¶²è·¯çˆ¬èŸ²ç·¨ç¢¼å•é¡Œåˆ†æå ±å‘Š
## æ—¥æœŸï¼š2025-06-22

### ğŸ” å•é¡Œæ‘˜è¦
æ‚¨åœ¨æ—¥èªŒä¸­çœ‹åˆ°çš„ç·¨ç¢¼è­¦å‘Šç¢ºå¯¦æŒ‡å‘äº†é‡è¦çš„ç¶²è·¯çˆ¬èŸ²å•é¡Œã€‚ç¶“éæ·±å…¥åˆ†æï¼Œæˆ‘å€‘ç™¼ç¾ä»¥ä¸‹æ ¸å¿ƒå•é¡Œï¼š

### ğŸ“Š æ¸¬è©¦çµæœ
| ç¶²ç«™ | ç‹€æ…‹ | æœ€ä½³ç·¨ç¢¼ | æ›¿æ›å­—ç¬¦æ•¸ | æœ‰æ„ç¾©å…§å®¹ |
|------|------|----------|-------------|------------|
| av-wiki.net | 200 OK | cp932 | 1025+ | âŒ ç„¡ |
| chiba-f.net | 200 OK | cp932 | 287+ | âŒ ç„¡ |

### âš ï¸ ç™¼ç¾çš„å•é¡Œ

#### 1. ç·¨ç¢¼å•é¡Œ
- **æ›¿æ›å­—ç¬¦éå¤š**ï¼šå³ä½¿ä½¿ç”¨æœ€ä½³ç·¨ç¢¼ `cp932`ï¼Œä»æœ‰å¤§é‡ `ï¿½` æ›¿æ›å­—ç¬¦
- **å…§å®¹ç„¡æ³•è§£æ**ï¼šé é¢æ¨™é¡Œé¡¯ç¤ºç‚ºã€Œç„¡æ¨™é¡Œã€
- **çµæ§‹è­˜åˆ¥å¤±æ•—**ï¼šç„¡æ³•æ‰¾åˆ°æœå°‹çµæœå®¹å™¨

#### 2. å¯èƒ½åŸå› 
1. **JavaScript å‹•æ…‹è¼‰å…¥**ï¼šå…§å®¹å¯èƒ½é€šé AJAX å‹•æ…‹è¼‰å…¥
2. **åçˆ¬èŸ²æ©Ÿåˆ¶**ï¼šç¶²ç«™è¿”å›åŠ å¯†æˆ–æ··æ·†çš„å…§å®¹
3. **ç‰¹æ®Šç·¨ç¢¼**ï¼šä½¿ç”¨äº†éæ¨™æº–å­—ç¬¦ç·¨ç¢¼
4. **è«‹æ±‚æ¨™é ­è¦æ±‚**ï¼šéœ€è¦ç‰¹å®šçš„ Cookie æˆ–æ¨™é ­

### ğŸ’¡ è§£æ±ºæ–¹æ¡ˆå»ºè­°

#### 1. çŸ­æœŸè§£æ±ºæ–¹æ¡ˆï¼ˆç«‹å³å¯å¯¦ä½œï¼‰

##### A. æ”¹é€²ç·¨ç¢¼è™•ç†
```python
class ImprovedEncodingHandler:
    def __init__(self):
        self.encoding_priority = ['cp932', 'shift_jis', 'utf-8', 'euc-jp']
    
    def smart_decode(self, content: bytes) -> str:
        for encoding in self.encoding_priority:
            try:
                decoded = content.decode(encoding, errors='replace')
                replacement_ratio = decoded.count('ï¿½') / len(decoded)
                
                # å¦‚æœæ›¿æ›å­—ç¬¦æ¯”ä¾‹å°æ–¼ 5%ï¼Œèªç‚ºç·¨ç¢¼æ­£ç¢º
                if replacement_ratio < 0.05:
                    return decoded, encoding
            except:
                continue
        
        # å›é€€åˆ° UTF-8
        return content.decode('utf-8', errors='replace'), 'utf-8'
```

##### B. å¢å¼·è«‹æ±‚æ¨™é ­
```python
ENHANCED_HEADERS = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
    'Accept-Language': 'ja,en-US;q=0.7,en;q=0.3',
    'Accept-Encoding': 'gzip, deflate, br',
    'Referer': 'https://www.google.com/',
    'DNT': '1',
    'Connection': 'keep-alive',
    'Upgrade-Insecure-Requests': '1'
}
```

##### C. è«‹æ±‚é–“éš”å’Œé‡è©¦
```python
import time
import random
from functools import wraps

def rate_limit(min_delay=1, max_delay=3):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            time.sleep(random.uniform(min_delay, max_delay))
            return func(*args, **kwargs)
        return wrapper
    return decorator
```

#### 2. ä¸­æœŸè§£æ±ºæ–¹æ¡ˆï¼ˆéœ€è¦é¡å¤–å¥—ä»¶ï¼‰

##### A. ä½¿ç”¨ Selenium é€²è¡Œç€è¦½å™¨è‡ªå‹•åŒ–
```python
from selenium import webdriver
from selenium.webdriver.chrome.options import Options

def create_chrome_driver():
    options = Options()
    options.add_argument('--headless')
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    options.add_argument('--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36')
    
    driver = webdriver.Chrome(options=options)
    return driver

def scrape_with_selenium(url: str):
    driver = create_chrome_driver()
    try:
        driver.get(url)
        time.sleep(3)  # ç­‰å¾… JavaScript è¼‰å…¥
        return driver.page_source
    finally:
        driver.quit()
```

##### B. ä½¿ç”¨ Playwrightï¼ˆæ¨è–¦ï¼‰
```python
from playwright.sync_api import sync_playwright

def scrape_with_playwright(url: str):
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        page = browser.new_page(
            user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        )
        
        page.goto(url)
        page.wait_for_load_state('networkidle')
        content = page.content()
        
        browser.close()
        return content
```

#### 3. é•·æœŸè§£æ±ºæ–¹æ¡ˆï¼ˆæ¶æ§‹æ”¹é€²ï¼‰

##### A. å¤šé‡çˆ¬èŸ²ç­–ç•¥
```python
class MultiScrapingStrategy:
    def __init__(self):
        self.strategies = [
            self.basic_requests,
            self.selenium_scraping,
            self.playwright_scraping
        ]
    
    def scrape(self, url: str):
        for strategy in self.strategies:
            try:
                result = strategy(url)
                if self.is_valid_content(result):
                    return result
            except Exception as e:
                logger.warning(f"Strategy failed: {e}")
                continue
        
        raise Exception("All scraping strategies failed")
```

##### B. æ™ºæ…§å¿«å–ç³»çµ±
```python
import hashlib
import pickle
from pathlib import Path

class SmartCache:
    def __init__(self, cache_dir='cache', ttl=3600):
        self.cache_dir = Path(cache_dir)
        self.cache_dir.mkdir(exist_ok=True)
        self.ttl = ttl
    
    def get_cache_key(self, url: str) -> str:
        return hashlib.md5(url.encode()).hexdigest()
    
    def get(self, url: str):
        cache_file = self.cache_dir / f"{self.get_cache_key(url)}.pkl"
        if cache_file.exists():
            mtime = cache_file.stat().st_mtime
            if time.time() - mtime < self.ttl:
                with open(cache_file, 'rb') as f:
                    return pickle.load(f)
        return None
    
    def set(self, url: str, data):
        cache_file = self.cache_dir / f"{self.get_cache_key(url)}.pkl"
        with open(cache_file, 'wb') as f:
            pickle.dump(data, f)
```

### ğŸ¯ å¯¦ä½œå„ªå…ˆé †åº

#### ç¬¬ä¸€éšæ®µï¼ˆç«‹å³å¯¦ä½œï¼‰
1. âœ… æ”¹é€²ç·¨ç¢¼æª¢æ¸¬å’Œè™•ç†é‚è¼¯
2. âœ… æ·»åŠ æ›´çœŸå¯¦çš„ç€è¦½å™¨æ¨™é ­
3. âœ… å¯¦ä½œè«‹æ±‚é–“éš”å’Œé‡è©¦æ©Ÿåˆ¶
4. âœ… åŠ å¼·éŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„

#### ç¬¬äºŒéšæ®µï¼ˆ1é€±å…§ï¼‰
1. ğŸ”„ æ¸¬è©¦å’Œæ•´åˆ Selenium æˆ– Playwright
2. ğŸ”„ å¯¦ä½œæ™ºæ…§å¿«å–ç³»çµ±
3. ğŸ”„ å»ºç«‹çˆ¬èŸ²æ•ˆèƒ½ç›£æ§
4. ğŸ”„ æ·»åŠ ä»£ç†ä¼ºæœå™¨æ”¯æ´

#### ç¬¬ä¸‰éšæ®µï¼ˆ2é€±å…§ï¼‰
1. ğŸ“ å®Œæ•´çš„çˆ¬èŸ²é‡æ§‹
2. ğŸ“ API ç«¯é»åˆ†æå’Œæ•´åˆ
3. ğŸ“ å¤šé‡çˆ¬èŸ²ç­–ç•¥å¯¦ä½œ
4. ğŸ“ è‡ªå‹•åŒ–æ¸¬è©¦å¥—ä»¶

### ğŸ“‹ æ¨è–¦çš„æª”æ¡ˆçµæ§‹
```
src/scrapers/
â”œâ”€â”€ enhanced/
â”‚   â”œâ”€â”€ encoding_handler.py      # æ”¹é€²çš„ç·¨ç¢¼è™•ç†
â”‚   â”œâ”€â”€ browser_automation.py    # ç€è¦½å™¨è‡ªå‹•åŒ–
â”‚   â”œâ”€â”€ smart_cache.py          # æ™ºæ…§å¿«å–ç³»çµ±
â”‚   â””â”€â”€ multi_strategy.py       # å¤šé‡çˆ¬èŸ²ç­–ç•¥
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ rate_limiter.py         # é »ç‡é™åˆ¶
â”‚   â”œâ”€â”€ proxy_manager.py        # ä»£ç†ç®¡ç†
â”‚   â””â”€â”€ monitoring.py           # æ•ˆèƒ½ç›£æ§
â””â”€â”€ tests/
    â”œâ”€â”€ test_encoding.py         # ç·¨ç¢¼æ¸¬è©¦
    â””â”€â”€ test_scrapers.py         # çˆ¬èŸ²æ¸¬è©¦
```

### ğŸ”§ ç«‹å³å¯åŸ·è¡Œçš„ä¿®å¾©

åŸºæ–¼åˆ†æçµæœï¼Œæˆ‘å»ºè­°æ‚¨ï¼š

1. **ç«‹å³æ›´æ–°ç¾æœ‰çˆ¬èŸ²æ¨¡çµ„**çš„ç·¨ç¢¼è™•ç†é‚è¼¯
2. **æ·»åŠ æ›´å¼·å¥çš„éŒ¯èª¤è™•ç†**ï¼Œé¿å…å› ç·¨ç¢¼å•é¡Œå°è‡´ç³»çµ±å´©æ½°
3. **å¯¦ä½œè«‹æ±‚é–“éš”**ï¼Œé¿å…è¢«ç¶²ç«™å°é–
4. **è€ƒæ…®ä½¿ç”¨ Selenium æˆ– Playwright** ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ

é€™äº›æ”¹é€²å°‡é¡¯è‘—æ¸›å°‘æ‚¨çœ‹åˆ°çš„ç·¨ç¢¼è­¦å‘Šï¼Œä¸¦æé«˜çˆ¬èŸ²çš„æˆåŠŸç‡å’Œç©©å®šæ€§ã€‚

---
**åˆ†æå®Œæˆæ™‚é–“**ï¼š2025-06-22  
**å»ºè­°å¯¦ä½œé †åº**ï¼šç·¨ç¢¼è™•ç† â†’ ç€è¦½å™¨è‡ªå‹•åŒ– â†’ å¿«å–ç³»çµ± â†’ å¤šé‡ç­–ç•¥

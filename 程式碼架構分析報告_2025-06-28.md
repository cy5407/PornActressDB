# 女優分類系統 - 程式碼架構分析報告

**報告日期**: 2025年6月28日

## 1. 專案概觀

本專案是一個使用 Python 開發的桌面應用程式，旨在幫助使用者智慧化地分類影片檔案。其核心功能是透過輸入影片的關鍵字（例如番號），從如 JavDB 等公開網站爬取影片資訊（如女優、片商），然後根據這些資訊自動將本地檔案歸類到對應的資料夾中。

專案採用了現代化的圖形使用者介面（GUI），並將業務邏輯、資料處理和使用者介面分離，展現了良好的軟體架構設計。

**主要技術棧:**
- **語言**: Python 3
- **GUI 框架**: `tkinter`，並透過 `ttkbootstrap` 進行主題美化。
- **網路請求**: `httpx` (用於非同步網路爬蟲)。
- **HTML 解析**: `BeautifulSoup`。
- **設定管理**: `JSON` (用於使用者偏好) 和 `configparser` (傳統 .ini 格式)。
- **資料庫**: `SQLite` (用於儲存結構化資料)。

## 2. 系統架構

本專案採用了典型的分層架構，將不同職責的程式碼分離到獨立的模組中，使得系統易於維護和擴充。主要結構位於 `女優分類/src/` 目錄下。

其核心分層如下：

- **`ui` (使用者介面層)**: 負責所有與使用者互動的視覺元件。這是使用者直接操作的部分。
- **`services` (服務層)**: 處理核心的業務邏輯，是 UI 層和底層資料/爬蟲層之間的橋樑。
- **`scrapers` (網路爬蟲層)**: 負責從外部網站抓取資料。每個爬蟲對應一個特定網站。
- **`models` (資料模型層)**: 定義應用程式中使用的核心資料結構，如影片、女優等。
- **`utils` (工具層)**: 提供跨模組使用的通用函式，如路徑處理、設定檔讀寫等。


*(這是一個基於程式碼邏輯推斷的簡易架構圖)*

## 3. 啟動流程

應用程式的啟動過程清晰明瞭：

1.  **外部啟動腳本 (`/run.py`)**: 位於專案根目錄的 `run.py` 是一個重定向腳本。它的唯一作用是設定好路徑，然後執行位於 `女優分類/` 子目錄下的主程式 `run.py`。這提供了一個方便的單一啟動點。

2.  **主程式進入點 (`/女優分類/run.py`)**:
    -   設定 Python 的系統路徑，確保 `src` 目錄下的模組可以被正確匯入。
    -   設定全域日誌（Logging），將日誌同時輸出到檔案 (`unified_classifier.log`) 和控制台。
    -   建立必要的資料夾，如 `data` 和 `cache`。
    -   初始化 `tkinter` 主視窗 (`tk.Tk()`)。
    -   嘗試使用 `ttkbootstrap` 來美化介面主題，如果失敗則退回使用原生 `tkinter` 樣式。
    -   實例化主 GUI 類別 `UnifiedActressClassifierGUI` (`ui/main_gui.py`)。
    -   進入 `tkinter` 的主事件迴圈 (`root.mainloop()`)，應用程式開始等待使用者操作。

## 4. 核心功能模組分析

### 4.1. 使用者介面 (UI Layer - `src/ui`)

UI 層完全基於 `tkinter` 建立，並透過 `Notebook` (頁籤) 將不同功能劃分開來。

-   **`main_gui.py`**: 作為主視窗的容器，它建立了 `Notebook` 元件，並將 `ClassificationView`, `SettingsView`, `LogView`, `AboutView` 作為不同的頁籤加入。

-   **`classification_view.py`**: 這是**核心功能介面**。
    -   **路徑設定**: 提供來源和目標資料夾的選擇功能。路徑會透過 `PreferenceService` 自動儲存和載入。
    -   **智慧搜尋**: 使用者輸入關鍵字（番號），點擊「搜尋」按鈕。此操作會觸發 `SearchService` 進行非同步的網路搜尋。
    -   **搜尋結果**: 搜尋到的結果會顯示在一個 `Treeview` 表格中，包含女優、片商和資料來源。
    -   **分類操作**: 使用者從結果中選擇一項，然後點擊「開始分類」。此操作會觸發 `ClassificationService` 來移動檔案。提供「預覽模式」可以只看不做，確保操作安全。

-   **`settings_view.py`**: 允許使用者自訂應用程式行為。
    -   可以設定 JavDB 的 URL、是否在分類時建立片商資料夾、更換 UI 主題等。
    -   所有設定都透過 `PreferenceService` 進行讀寫。

-   **`log_view.py`** 和 **`about_view.py`**: 分別提供查看執行日誌和應用程式版本資訊的功能。

-   **`custom_widgets.py`**: 包含一些自訂的 UI 元件，如 `Tooltip` (滑鼠提示)、`ResizableMessagebox` (可調整大小的訊息框)，提升了使用者體驗。

### 4.2. 服務層 (Service Layer - `src/services`)

服務層是應用程式的大腦，處理所有複雜的邏輯。

-   **`search_service.py`**: 整合了多個網路爬蟲。
    -   它接收來自 UI 的搜尋請求，並可以**同時**對多個網站（如 JavDB, FC2）發起非同步搜尋。
    -   使用 `asyncio.gather` 來併發執行所有爬蟲任務，大幅提升搜尋效率。
    -   對每個爬蟲的呼叫都進行了錯誤處理，確保單一爬蟲的失敗不會影響其他爬蟲。

-   **`classification_service.py`**: 負責檔案分類的核心邏輯。
    -   接收從 UI 層傳來的分類資訊（女優、片商）。
    -   使用 `path_utils` 中的工具來產生安全、標準化的資料夾名稱。
    -   根據設定判斷是否要建立片商子資料夾。
    -   使用 `shutil.move` 來移動檔案，並支援 `dry_run`（預覽模式）。

-   **`preference_service.py`**: 管理使用者偏好設定。
    -   將設定以 `JSON` 格式儲存在 `config/preferences.json` 檔案中。
    -   提供了簡單的 `get` 和 `set` 方法，並支援巢狀鍵值（如 `api_keys.openai`）。
    -   這是目前 UI 主要使用的設定管理方式。

-   **`database_service.py`**: 管理一個 SQLite 資料庫。
    -   定義了 `actresses`, `studios`, `videos` 等表格，用於儲存爬取到的結構化資料。
    -   這為未來實現歷史記錄、資料快取等進階功能打下了基礎。

-   **`file_service.py`**: 提供了一些基本的檔案系統操作封裝，如獲取目錄下的檔案列表。

### 4.3. 網路爬蟲層 (Scraper Layer - `src/scrapers`)

此層負責從網路上獲取資料，設計上具有良好的擴充性。

-   **`base_scraper.py`**: 定義了一個抽象基底類別 `BaseScraper`。
    -   所有具體的爬蟲都必須繼承它，並實作 `search` 和 `get_details` 兩個方法。
    -   它還提供了統一的網路請求 (`_make_request` 使用 `httpx`) 和 HTML 解析 (`_parse_html` 使用 `BeautifulSoup`) 的輔助函式，並定義了統一的錯誤類型。

-   **`javdb_scraper.py`**: 針對 JavDB 網站的爬蟲實作。
    -   能夠處理搜尋關鍵字，並解析搜尋結果列表。
    -   能夠智能判斷搜尋是否直接跳轉到了最終的影片頁面，並直接解析該頁面的詳細資訊。
    -   詳細解析了影片頁面的各個欄位，如標題、演員、片商、日期等。

-   **`fc2_scraper.py`** 和 **`chiba_f_net_scraper.py`**: 其他網站的爬蟲實作，展示了系統可以輕易地透過新增爬蟲類別來支援更多資料來源。

### 4.4. 資料模型 (Data Models - `src/models`)

此層使用 `dataclasses` 來定義清晰、簡潔的資料結構。

-   **`actress.py`**, **`video.py`**, **`studio.py`**: 分別定義了女優、影片和片商的資料模型。
-   **`enums.py`**: 使用 `Enum` 定義了如 `ScraperType` (爬蟲類型) 等枚舉，讓程式碼更具可讀性和安全性。

### 4.5. 工具函式 (Utilities - `src/utils`)

-   **`path_utils.py`**: 提供了 `get_valid_filename` 函式，可以將任意字串轉換為在 Windows 和其他作業系統上都有效的檔案/資料夾名稱，這是確保程式穩定性的關鍵。
-   **`async_utils.py`**: 提供了 `run_async_in_thread` 函式，用於在同步的 `tkinter` 環境中執行非同步的爬蟲程式碼，解決了 GUI 卡頓的問題。
-   **`config_manager.py`**: 一個基於 `configparser` 的 .ini 檔案管理器。雖然存在，但目前新的 UI 部分主要依賴 `PreferenceService`。
-   **`singleton.py`**: 提供了一個單例模式的裝飾器，可用於需要確保全域唯一的管理類別。

## 5. 總結

此「女優分類系統」是一個設計精良的 Python 桌面應用程式。其主要優點包括：

-   **高度模組化**: 各層職責分明，UI、業務邏輯、資料來源完全解耦。
-   **易於擴充**: 新增一個資料來源只需要在 `scrapers` 目錄下新增一個檔案，並在 `SearchService` 中註冊即可。
-   **非同步核心**: 透過 `asyncio` 和 `httpx` 實現了高效的網路操作，避免了 GUI 無回應的問題。
-   **使用者友善**: 提供了圖形介面、預覽模式和可自訂的設定，考慮了終端使用者的體驗。
-   **穩健的檔案操作**: 對檔案路徑和名稱進行了嚴格的處理，減少了因特殊字元導致的錯誤。

總體而言，這是一個成熟且可維護的專案，為未來的進一步功能開發（如更複雜的資料庫互動、AI 智慧推薦等）奠定了堅實的基礎。

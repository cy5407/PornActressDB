# 片商分類空資料夾處理錯誤修正報告

**建立日期**: 2025-06-22  
**修正問題**: 解決片商分類功能在未找到女優資料夾時的 KeyError 'moved' 錯誤

## 🐛 問題描述

### 錯誤現象
```
🏢 片商分類模式
目標資料夾: C:\Users\cy540\Downloads\AV\單體企劃女優
============================================================
🏢 開始片商分類：C:\Users\cy540\Downloads\AV\單體企劃女優
============================================================
🔍 正在掃描根目錄的女優資料夾（僅第一層）...
🤷 未找到任何女優資料夾

💥 片商分類發生未預期錯誤: 'moved'
```

### 根本原因
當片商分類功能掃描目標資料夾但未找到任何女優資料夾時：

1. **不完整的返回值**: `classify_actresses_by_studio` 函式返回的結果缺少 `move_stats` 字段
2. **GUI 期望不符**: GUI 的 `main_gui.py` 期望所有成功的結果都包含完整的 `move_stats` 統計
3. **不安全的字典存取**: `get_classification_summary` 函式使用 `move_stats['moved']` 直接存取，沒有容錯處理

## 🔧 修正內容

### 1. 修正空資料夾返回值 (`studio_classifier.py`)

**修正前**:
```python
if not actress_folders:
    if progress_callback:
        progress_callback("🤷 未找到任何女優資料夾\n")
    return {'status': 'success', 'message': '未找到女優資料夾'}
```

**修正後**:
```python
if not actress_folders:
    if progress_callback:
        progress_callback("🤷 未找到任何女優資料夾\n")
    # 返回空的移動統計，避免 GUI 錯誤
    empty_move_stats = {
        'moved': 0,
        'solo_artist': 0,
        'failed': 0,
        'skipped': 0
    }
    return {
        'status': 'success',
        'message': '未找到女優資料夾',
        'total_actresses': 0,
        'updated_count': 0,
        'move_stats': empty_move_stats
    }
```

### 2. 加強字典存取安全性 (`studio_classifier.py`)

**修正前**:
```python
f"  ✅ 移動到片商資料夾: {move_stats['moved']}\n"
f"  🎭 移動到{solo_folder_name}: {move_stats['solo_artist']}\n"
f"  ❌ 移動失敗: {move_stats['failed']}\n"
```

**修正後**:
```python
f"  ✅ 移動到片商資料夾: {move_stats.get('moved', 0)}\n"
f"  🎭 移動到{solo_folder_name}: {move_stats.get('solo_artist', 0)}\n"
f"  ❌ 移動失敗: {move_stats.get('failed', 0)}\n"
```

## ✅ 測試驗證

執行 `test_empty_folder_fix.py` 測試結果：

```
📊 片商分類完成！

  📁 掃描女優總數: 0
  ✅ 移動到片商資料夾: 0
  🎭 移動到單體企劃女優: 0
  ⏩ 跳過處理: 0
  ❌ 移動失敗: 0

💡 已存在的資料夾已自動合併內容
```

## 🎯 修正效果

1. **完全消除 KeyError**: 不再出現 `'moved'` 鍵值錯誤
2. **一致的返回格式**: 所有情況下都返回完整的結構化資料
3. **更好的用戶體驗**: 空資料夾情況下也能顯示完整的統計摘要
4. **增強容錯性**: 使用 `.get()` 函式避免未來的類似問題

## 📁 修改檔案

- `女優分類/src/services/studio_classifier.py`
  - `classify_actresses_by_studio` 函式：完善空資料夾返回值
  - `get_classification_summary` 函式：增強字典存取安全性

## 💡 預防措施

1. **統一返回格式**: 確保所有成功結果都包含相同的字段結構
2. **安全存取模式**: 使用 `.get()` 函式存取可能不存在的字典鍵值
3. **完整測試覆蓋**: 包含邊界情況（如空資料夾）的測試案例

---

**✅ 修正完成**: 片商分類功能現在能正確處理空資料夾情況，不會再出現 KeyError 錯誤。
